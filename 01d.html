<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>è¡ŒåŠ¨æ‰“å¡ç³»ç»Ÿ</title>
<style>
  body { max-width: 700px; margin: 40px auto; font-family: system-ui; background: #f5f5f5; }
  .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .task { display: flex; align-items: center; padding: 12px; margin: 8px 0; background: #f9f9f9; border-radius: 8px; }
  .task input { margin-right: 12px; transform: scale(1.3); }
  .task.done { opacity: 0.5; text-decoration: line-through; }
  button { width: 100%; padding: 16px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; }
  .btn-primary { background: #4CAF50; color: white; }
  .btn-primary:disabled { background: #ccc; }
  .reward { padding: 12px; margin: 8px 0; background: #e3f2fd; border-radius: 8px; }
  .reward.unlocked { background: #c8e6c9; font-weight: bold; }
  .settings { display: none; margin-top: 20px; }
  textarea { width: 100%; height: 100px; margin: 8px 0; }
  .streak-info { background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
  
  /* æ—¥å†æ ·å¼ */
  .calendar { margin-bottom: 20px; }
  .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
  .calendar-day { 
    aspect-ratio: 1; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    border-radius: 8px; 
    font-size: 14px;
    cursor: pointer;
    position: relative;
  }
  .calendar-day.empty { background: transparent; }
  .calendar-day.today { border: 2px solid #2196F3; }
  .calendar-day.checked { background: #4CAF50; color: white; }
  .calendar-day.checked.old-version { background: #81C784; } /* æ—§ç‰ˆæœ¬çš„é¢œè‰² */
  .calendar-day.checked.current-version { background: #4CAF50; } /* å½“å‰ç‰ˆæœ¬çš„é¢œè‰² */
  .calendar-day-label { font-size: 11px; margin-top: 2px; }
  
  /* ç»Ÿè®¡ä¿¡æ¯ */
  .stats-grid { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 10px; 
    margin-top: 15px;
  }
  .stat-box { 
    background: #f8f9fa; 
    padding: 10px; 
    border-radius: 8px; 
    text-align: center;
  }
  .stat-value { 
    font-size: 24px; 
    font-weight: bold; 
    color: #2196F3;
  }
  .stat-label { 
    font-size: 12px; 
    color: #666;
  }
</style>
</head>
<body>
<div class="card">
  <h2>ğŸ“… è¡ŒåŠ¨æ‰“å¡ç³»ç»Ÿ</h2>
  <div class="streak-info">
    <p>è¿ç»­å¤©æ•°ï¼š<strong id="streak">0</strong>å¤© | ä»Šæ—¥ï¼š<strong id="score">0</strong>åˆ† | æ€»ç§¯åˆ†ï¼š<strong id="totalScore">0</strong></p>
    <p style="font-size: 12px; color: #666; margin-top: 5px;" id="lastCheckIn"></p>
  </div>
  
  <!-- æ—¥å†é¢æ¿ -->
  <div class="calendar">
    <div class="calendar-header">
      <button onclick="changeMonth(-1)" style="width: auto; padding: 5px 10px; font-size: 14px;">â—€</button>
      <h3 id="currentMonth">2023å¹´12æœˆ</h3>
      <button onclick="changeMonth(1)" style="width: auto; padding: 5px 10px; font-size: 14px;">â–¶</button>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- æ—¥å†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div style="display: flex; justify-content: center; margin-top: 10px; font-size: 12px; color: #666;">
      <div style="display: flex; align-items: center; margin-right: 15px;">
        <div style="width: 15px; height: 15px; background: #4CAF50; border-radius: 3px; margin-right: 5px;"></div>
        <span>å½“å‰ç‰ˆæœ¬æ‰“å¡</span>
      </div>
      <div style="display: flex; align-items: center;">
        <div style="width: 15px; height: 15px; background: #81C784; border-radius: 3px; margin-right: 5px;"></div>
        <span>æ—§ç‰ˆæœ¬æ‰“å¡</span>
      </div>
    </div>
  </div>
  
  <div class="stats-grid">
    <div class="stat-box">
      <div class="stat-value" id="monthChecked">0</div>
      <div class="stat-label">æœ¬æœˆæ‰“å¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="weekChecked">0</div>
      <div class="stat-label">æœ¬å‘¨æ‰“å¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="completionRate">0%</div>
      <div class="stat-label">å®Œæˆç‡</div>
    </div>
  </div>
</div>

<div class="card">
  <h3>ğŸ“ ä»Šæ—¥ä»»åŠ¡</h3>
  <div id="taskList"></div>
  <button class="btn-primary" id="checkInBtn" onclick="checkIn()">ğŸ¯ ä»Šæ—¥æ‰“å¡</button>
  <p style="font-size: 12px; color: #666; margin-top: 10px;">å®Œæˆâ‰¥3é¡¹=60åˆ†ï¼Œå…¨éƒ¨å®Œæˆ=100åˆ†</p>
</div>

<div class="card">
  <h3>ğŸ å¥–åŠ±è¿›åº¦</h3>
  <div id="rewardList"></div>
</div>

<div class="card">
  <button onclick="toggleSettings()" style="background: #2196F3; color: white; padding: 10px;">âš™ï¸ ç¼–è¾‘ä»»åŠ¡/å¥–åŠ±</button>
  <div class="settings" id="settings">
    <h4>ä»»åŠ¡åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</h4>
    <textarea id="taskInput">è·‘æ­¥ï¼ˆä¸è®¡é‡ï¼‰
å•è¯+å¬åŠ›ï¼ˆä¸è®¡é‡ï¼‰
æ•°å­¦æ±¤å®¶å‡¤ï¼ˆä¸è®¡é‡ï¼‰
æœŸæœ«ä¸¤é—¨è¯¾å¤ä¹ ï¼ˆä¸è®¡é‡ï¼‰
æ— æ°§è¿åŠ¨</textarea>
    <h4>å¥–åŠ±è®¾ç½®ï¼ˆæ ¼å¼ï¼šå¤©æ•°-æè¿°ï¼‰</h4>
    <textarea id="rewardInput">3-å¥–åŠ±1å°æ—¶å¨±ä¹
7-å¥–åŠ±å¤§é¤50å…ƒ
14-å°ç¤¼ç‰©100å…ƒ
30-å¿ƒæ„å¤§ä»¶300å…ƒ</textarea>
    <div style="margin-top: 15px;">
      <button onclick="saveSettings()" style="background: #ff9800; color: white; margin-right: 10px;">ä¿å­˜è®¾ç½®</button>
      <button onclick="resetData()" style="background: #f44336; color: white;">é‡ç½®æ•°æ®</button>
    </div>
  </div>
</div>

<script>
// é»˜è®¤æ•°æ®
const defaultTasks = ["è·‘æ­¥ï¼ˆä¸è®¡é‡ï¼‰","å•è¯+å¬åŠ›ï¼ˆä¸è®¡é‡ï¼‰","æ•°å­¦æ±¤å®¶å‡¤ï¼ˆä¸è®¡é‡ï¼‰","æœŸæœ«ä¸¤é—¨è¯¾å¤ä¹ ï¼ˆä¸è®¡é‡ï¼‰","æ— æ°§è¿åŠ¨"];
const defaultRewards = [
  {day: 3, desc: "å¥–åŠ±1å°æ—¶å¨±ä¹"},
  {day: 7, desc: "å¥–åŠ±å¤§é¤50å…ƒ"},
  {day: 14, desc: "å°ç¤¼ç‰©100å…ƒ"},
  {day: 30, desc: "å¿ƒæ„å¤§ä»¶300å…ƒ"}
];

// å½“å‰æŸ¥çœ‹çš„æœˆä»½
let currentViewDate = new Date();
currentViewDate.setDate(1); // è®¾ä¸ºå½“æœˆç¬¬ä¸€å¤©

// åŠ è½½æ•°æ®
function loadData() {
  const saved = localStorage.getItem('checkinData');
  if (!saved) {
    return {
      tasks: defaultTasks.map(t => ({name: t, done: false})),
      rewards: defaultRewards.map(r => ({...r, claimed: false})),
      streak: 0,
      lastCheckIn: null,
      todayChecked: false,
      totalScore: 0,
      history: [], // æ–°å¢ï¼šå†å²è®°å½•
      taskVersion: generateTaskVersion(defaultTasks) // å½“å‰ä»»åŠ¡ç‰ˆæœ¬
    };
  }
  
  const data = JSON.parse(saved);
  
  // ç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´æ€§
  if (!data.totalScore) data.totalScore = 0;
  if (!data.history) data.history = [];
  if (!data.taskVersion) data.taskVersion = generateTaskVersion(data.tasks || defaultTasks);
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜¨å¤©æ‰“å¡çš„
  const today = new Date().toDateString();
  if (data.lastCheckIn && data.lastCheckIn !== today) {
    // å¦‚æœæ˜¯æ˜¨å¤©æ‰“å¡çš„ï¼Œä¿æŒè¿ç»­å¤©æ•°ï¼Œé‡ç½®ä»Šæ—¥çŠ¶æ€
    if (isYesterday(data.lastCheckIn)) {
      data.todayChecked = false;
      data.tasks.forEach(t => t.done = false);
    } else if (!isToday(data.lastCheckIn)) {
      // å¦‚æœä¸æ˜¯æ˜¨å¤©ä¹Ÿä¸æ˜¯ä»Šå¤©ï¼Œä¸­æ–­è¿ç»­å¤©æ•°
      data.streak = 0;
      data.todayChecked = false;
      data.tasks.forEach(t => t.done = false);
    }
  }
  
  return data;
}

// ä¿å­˜æ•°æ®
function saveData(data) {
  localStorage.setItem('checkinData', JSON.stringify(data));
}

// ç”Ÿæˆä»»åŠ¡ç‰ˆæœ¬æ ‡è¯†
function generateTaskVersion(tasks) {
  const taskString = tasks.map(t => typeof t === 'object' ? t.name : t).join('|');
  // ç®€å•çš„å“ˆå¸Œå‡½æ•°
  let hash = 0;
  for (let i = 0; i < taskString.length; i++) {
    hash = ((hash << 5) - hash) + taskString.charCodeAt(i);
    hash |= 0; // è½¬æ¢ä¸º32ä½æ•´æ•°
  }
  return hash.toString(16); // è½¬æ¢ä¸º16è¿›åˆ¶
}

// æ£€æŸ¥æ˜¯å¦ä¸ºæ˜¨å¤©
function isYesterday(dateString) {
  const date = new Date(dateString);
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  return date.toDateString() === yesterday.toDateString();
}

// æ£€æŸ¥æ˜¯å¦ä¸ºä»Šå¤©
function isToday(dateString) {
  return new Date(dateString).toDateString() === new Date().toDateString();
}

// æ¸²æŸ“æ‰€æœ‰
function renderAll() {
  renderCalendar();
  renderTasks();
  renderRewards();
  updateStreakInfo();
  updateStats();
}

// æ¸²æŸ“æ—¥å†
function renderCalendar() {
  const data = loadData();
  const calendarGrid = document.getElementById('calendarGrid');
  const currentMonthEl = document.getElementById('currentMonth');
  
  // è®¾ç½®æœˆä»½æ ‡é¢˜
  const monthNames = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
  const year = currentViewDate.getFullYear();
  const month = currentViewDate.getMonth();
  currentMonthEl.textContent = `${year}å¹´${monthNames[month]}`;
  
  // æ¸…ç©ºæ—¥å†
  calendarGrid.innerHTML = '';
  
  // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
  const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
  weekDays.forEach(day => {
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    dayEl.innerHTML = `<div style="font-weight: bold;">${day}</div>`;
    calendarGrid.appendChild(dayEl);
  });
  
  // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
  const firstDay = new Date(year, month, 1);
  const firstDayWeekday = firstDay.getDay(); // 0æ˜¯æ˜ŸæœŸæ—¥
  
  // æ·»åŠ ç©ºç™½æ ¼å­
  for (let i = 0; i < firstDayWeekday; i++) {
    const emptyDay = document.createElement('div');
    emptyDay.className = 'calendar-day empty';
    calendarGrid.appendChild(emptyDay);
  }
  
  // è·å–å½“æœˆå¤©æ•°
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const today = new Date();
  
  // è·å–å†å²è®°å½•ä¸­çš„æ‰“å¡æ•°æ®
  const historyByDate = {};
  data.history.forEach(record => {
    historyByDate[record.date] = record;
  });
  
  // è·å–å½“å‰ä»»åŠ¡ç‰ˆæœ¬
  const currentTaskVersion = data.taskVersion;
  
  // æ·»åŠ æ—¥æœŸæ ¼å­
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateString = date.toDateString();
    const dateKey = formatDate(date);
    
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
    if (date.toDateString() === today.toDateString()) {
      dayEl.classList.add('today');
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å¡è®°å½•
    if (historyByDate[dateKey]) {
      const record = historyByDate[dateKey];
      dayEl.classList.add('checked');
      
      // æ ¹æ®ä»»åŠ¡ç‰ˆæœ¬å†³å®šé¢œè‰²
      if (record.taskVersion === currentTaskVersion) {
        dayEl.classList.add('current-version');
      } else {
        dayEl.classList.add('old-version');
      }
      
      // æ·»åŠ åˆ†æ•°æç¤º
      dayEl.title = `æ‰“å¡æ—¥æœŸ: ${dateKey}\nå¾—åˆ†: ${record.score}åˆ†`;
    }
    
    dayEl.innerHTML = `
      <div>${day}</div>
      <div class="calendar-day-label">${date.getDate() === 1 ? monthNames[month] : ''}</div>
    `;
    
    // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
    dayEl.onclick = () => {
      if (historyByDate[dateKey]) {
        const record = historyByDate[dateKey];
        alert(`ğŸ“… ${dateKey}\nå¾—åˆ†: ${record.score}åˆ†\nä»»åŠ¡ç‰ˆæœ¬: ${record.taskVersion === currentTaskVersion ? 'å½“å‰ç‰ˆæœ¬' : 'æ—§ç‰ˆæœ¬'}`);
      } else {
        alert(`ğŸ“… ${dateKey}\næœªæ‰“å¡`);
      }
    };
    
    calendarGrid.appendChild(dayEl);
  }
}

// æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// åˆ‡æ¢æœˆä»½
function changeMonth(delta) {
  currentViewDate.setMonth(currentViewDate.getMonth() + delta);
  renderCalendar();
  updateStats();
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats() {
  const data = loadData();
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  // æœ¬æœˆæ‰“å¡å¤©æ•°
  const monthChecked = data.history.filter(record => {
    const recordDate = new Date(record.date);
    return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
  }).length;
  
  // æœ¬å‘¨æ‰“å¡å¤©æ•°ï¼ˆå‘¨ä¸€å¼€å§‹ï¼‰
  const weekChecked = data.history.filter(record => {
    const recordDate = new Date(record.date);
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1); // å‘¨ä¸€
    startOfWeek.setHours(0, 0, 0, 0);
    
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6); // å‘¨æ—¥
    endOfWeek.setHours(23, 59, 59, 999);
    
    return recordDate >= startOfWeek && recordDate <= endOfWeek;
  }).length;
  
  // æœ¬æœˆå®Œæˆç‡ï¼ˆæœ¬æœˆå·²è¿‡å¤©æ•°ä¸­æ‰“å¡çš„æ¯”ä¾‹ï¼‰
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const daysPassed = Math.min(today.getDate(), daysInMonth);
  const completionRate = daysPassed > 0 ? Math.round((monthChecked / daysPassed) * 100) : 0;
  
  document.getElementById('monthChecked').textContent = monthChecked;
  document.getElementById('weekChecked').textContent = weekChecked;
  document.getElementById('completionRate').textContent = `${completionRate}%`;
  document.getElementById('totalScore').textContent = data.totalScore;
}

// æ¸²æŸ“ä»»åŠ¡
function renderTasks() {
  const data = loadData();
  const list = document.getElementById('taskList');
  
  list.innerHTML = data.tasks.map((task, i) => `
    <div class="task ${task.done ? 'done' : ''}">
      <input type="checkbox" ${task.done ? 'checked' : ''} 
             ${data.todayChecked ? 'disabled' : ''}
             onchange="toggleTask(${i})" id="task${i}">
      <label for="task${i}">${task.name}</label>
    </div>
  `).join('');
  
  updateScore();
}

// åˆ‡æ¢ä»»åŠ¡çŠ¶æ€
function toggleTask(index) {
  const data = loadData();
  if (!data.todayChecked) {
    data.tasks[index].done = !data.tasks[index].done;
    saveData(data);
    renderTasks();
  }
}

// è®¡ç®—åˆ†æ•°
function updateScore() {
  const data = loadData();
  const doneCount = data.tasks.filter(t => t.done).length;
  const score = doneCount >= 3 ? (doneCount === data.tasks.length ? 100 : 60) : 0;
  document.getElementById('score').textContent = score;
  
  const btn = document.getElementById('checkInBtn');
  if (data.todayChecked) {
    btn.disabled = true;
    btn.textContent = 'ä»Šæ—¥å·²æ‰“å¡';
  } else if (doneCount < 3) {
    btn.disabled = true;
    btn.textContent = `è¿˜éœ€å®Œæˆ${3-doneCount}é¡¹æ‰èƒ½æ‰“å¡`;
  } else {
    btn.disabled = false;
    btn.textContent = 'ğŸ¯ ä»Šæ—¥æ‰“å¡';
  }
}

// æ›´æ–°è¿ç»­å¤©æ•°ä¿¡æ¯
function updateStreakInfo() {
  const data = loadData();
  document.getElementById('streak').textContent = data.streak;
  
  const lastCheckInEl = document.getElementById('lastCheckIn');
  if (data.lastCheckIn) {
    const lastDate = new Date(data.lastCheckIn);
    const today = new Date();
    const diffTime = today - lastDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
      lastCheckInEl.textContent = `ä¸Šæ¬¡æ‰“å¡ï¼šä»Šå¤©`;
    } else if (diffDays === 1) {
      lastCheckInEl.textContent = `ä¸Šæ¬¡æ‰“å¡ï¼šæ˜¨å¤©`;
    } else {
      lastCheckInEl.textContent = `ä¸Šæ¬¡æ‰“å¡ï¼š${diffDays}å¤©å‰`;
    }
  } else {
    lastCheckInEl.textContent = 'è¿˜æœªå¼€å§‹æ‰“å¡';
  }
}

// æ‰“å¡
function checkIn() {
  const data = loadData();
  const today = new Date();
  const todayString = today.toDateString();
  const dateKey = formatDate(today);
  
  if (data.todayChecked) {
    alert('ä»Šå¤©å·²ç»æ‰“è¿‡å¡äº†ï¼');
    return;
  }
  
  // è®¡ç®—è¿ç»­å¤©æ•°
  if (data.lastCheckIn) {
    const lastDate = new Date(data.lastCheckIn);
    const diffTime = today - lastDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) {
      data.streak++;
    } else if (diffDays > 1) {
      data.streak = 1;
    }
  } else {
    data.streak = 1;
  }
  
  // è®¡ç®—ä»Šæ—¥å¾—åˆ†
  const doneCount = data.tasks.filter(t => t.done).length;
  const todayScore = doneCount >= 3 ? (doneCount === data.tasks.length ? 100 : 60) : 0;
  
  // è®°å½•å†å²
  const historyRecord = {
    date: dateKey,
    score: todayScore,
    taskVersion: data.taskVersion,
    tasks: data.tasks.map(t => ({name: t.name, done: t.done}))
  };
  
  // æ·»åŠ æˆ–æ›´æ–°å†å²è®°å½•
  const existingIndex = data.history.findIndex(record => record.date === dateKey);
  if (existingIndex >= 0) {
    data.history[existingIndex] = historyRecord;
  } else {
    data.history.push(historyRecord);
  }
  
  data.lastCheckIn = todayString;
  data.todayChecked = true;
  data.totalScore += todayScore;
  
  saveData(data);
  
  // æ£€æŸ¥å¥–åŠ±
  checkRewards();
  
  renderAll();
  
  // æ˜¾ç¤ºæ‰“å¡ç»“æœ
  let message = `ğŸ‰ æ‰“å¡æˆåŠŸï¼\nè¿ç»­å¤©æ•°ï¼š${data.streak}å¤©`;
  if (todayScore === 100) {
    message += '\nğŸŠ å¤ªæ£’äº†ï¼å®Œæˆæ‰€æœ‰ä»»åŠ¡ï¼';
  } else if (todayScore === 60) {
    message += '\nğŸ‘ å®ŒæˆåŸºç¡€ç›®æ ‡ï¼';
  }
  alert(message);
}

// æ£€æŸ¥å¥–åŠ±
function checkRewards() {
  const data = loadData();
  let newRewards = [];
  
  data.rewards.forEach(r => {
    if (data.streak >= r.day && !r.claimed) {
      r.claimed = true;
      newRewards.push(r);
    }
  });
  
  if (newRewards.length > 0) {
    saveData(data);
    let message = 'ğŸ æ­å–œè·å¾—æ–°å¥–åŠ±ï¼\n';
    newRewards.forEach(r => {
      message += `\nåšæŒ${r.day}å¤©ï¼š${r.desc}`;
    });
    setTimeout(() => alert(message), 300);
  }
}

// æ¸²æŸ“å¥–åŠ±
function renderRewards() {
  const data = loadData();
  const list = document.getElementById('rewardList');
  
  list.innerHTML = data.rewards.map(r => {
    const unlocked = data.streak >= r.day;
    const claimed = r.claimed;
    
    return `
      <div class="reward ${unlocked ? 'unlocked' : ''}">
        <div style="display: flex; justify-content: space-between;">
          <span>${r.desc}</span>
          <span style="font-size: 14px; color: ${unlocked ? '#388e3c' : '#757575'}">
            ${unlocked ? 'âœ… å·²è¾¾æˆ' : `éœ€åšæŒ${r.day}å¤©`}
          </span>
        </div>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          å½“å‰è¿›åº¦ï¼š${data.streak}/${r.day}å¤©
          ${claimed ? 'ï¼ˆå·²é¢†å–ï¼‰' : ''}
        </div>
      </div>
    `;
  }).join('');
}

// åˆ‡æ¢è®¾ç½®é¢æ¿
function toggleSettings() {
  const settings = document.getElementById('settings');
  settings.style.display = settings.style.display === 'block' ? 'none' : 'block';
  
  if (settings.style.display === 'block') {
    const data = loadData();
    document.getElementById('taskInput').value = data.tasks.map(t => t.name).join('\n');
    document.getElementById('rewardInput').value = data.rewards.map(r => `${r.day}-${r.desc}`).join('\n');
  }
}

// ä¿å­˜è®¾ç½®
function saveSettings() {
  const taskInput = document.getElementById('taskInput').value;
  const rewardInput = document.getElementById('rewardInput').value;
  
  const tasks = taskInput.split('\n').filter(t => t.trim()).map(name => ({
    name: name.trim(),
    done: false
  }));
  
  const rewards = rewardInput.split('\n')
    .filter(r => r.trim())
    .map(line => {
      const match = line.match(/^(\d+)\s*-\s*(.+)$/);
      if (match) {
        return {
          day: parseInt(match[1]),
          desc: match[2].trim(),
          claimed: false
        };
      }
      return null;
    })
    .filter(r => r !== null)
    .sort((a, b) => a.day - b.day);
  
  const data = loadData();
  const oldTaskVersion = data.taskVersion;
  data.tasks = tasks;
  data.rewards = rewards;
  data.taskVersion = generateTaskVersion(tasks);
  
  // ä¿ç•™å·²è§£é”çš„å¥–åŠ±çŠ¶æ€s
  rewards.forEach(r => {
    const oldReward = data.rewards.find(old => old.day === r.day);
    if (oldReward && oldReward.claimed && data.streak >= r.day) {
      r.claimed = true;
    }
  });
  
  // æ›´æ–°å†å²è®°å½•ä¸­çš„ä»»åŠ¡ç‰ˆæœ¬ä¿¡æ¯
  data.history.forEach(record => {
    if (record.taskVersion === oldTaskVersion) {
      record.taskVersion = data.taskVersion;
    }
  });
  
  saveData(data);
  renderAll();
  toggleSettings();
  alert('è®¾ç½®å·²ä¿å­˜ï¼\næ³¨æ„ï¼šä»»åŠ¡ç‰ˆæœ¬å·²æ›´æ–°ï¼Œå†å²æ‰“å¡è®°å½•å°†ä½¿ç”¨æ–°é¢œè‰²æ˜¾ç¤ºã€‚');
}

// é‡ç½®æ•°æ®
function resetData() {
  if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ‰“å¡è®°å½•å’Œè¿›åº¦ï¼')) {
    localStorage.removeItem('checkinData');
    currentViewDate = new Date();
    currentViewDate.setDate(1);
    renderAll();
    alert('æ•°æ®å·²é‡ç½®ï¼');
  }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  renderAll();
});
</script>
</body>
</html>

