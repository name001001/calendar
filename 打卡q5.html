<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆé•¿æ‰“å¡ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 16px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            padding: 10px;
            min-height: 100vh;
            max-width: 750px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-title::before {
            content: "ğŸ¯";
            font-size: 1.6rem;
        }
        
        .toggle-btn {
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid rgba(67, 97, 238, 0.3);
            color: var(--primary);
            border-radius: 12px;
            padding: 6px 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .toggle-btn:hover {
            background: rgba(67, 97, 238, 0.2);
        }
        
        .toggle-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .settings-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: var(--border-radius);
            border: 1px solid #e0e6ff;
        }
        
        .settings-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .config-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }
        
        .config-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-title::before {
            content: "âš™ï¸";
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            resize: vertical;
            background: #fafaff;
            transition: var(--transition);
        }
        
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }
        
        .task {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f9fbfd;
            border-radius: 14px;
            transition: var(--transition);
            border-left: 3px solid var(--primary);
        }
        
        .task:hover {
            background: #f0f7ff;
            transform: translateX(3px);
        }
        
        .task-checkbox {
            width: 26px;
            height: 26px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
            transition: var(--transition);
        }
        
        .task-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .task-checkbox.checked::after {
            content: "âœ“";
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .task-name {
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .task-desc {
            font-size: 0.95rem;
            color: var(--gray);
            line-height: 1.4;
        }
        
        .score-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .score-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .streak-info {
            background: rgba(67, 97, 238, 0.08);
            border-radius: 14px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .streak-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
            margin: 5px 0;
            text-shadow: 0 2px 4px rgba(67, 97, 238, 0.2);
        }
        
        .score-display {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }
        
        .score-item {
            text-align: center;
            flex: 1;
        }
        
        .score-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
        }
        
        .score-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .action-btn {
            display: block;
            width: 100%;
            padding: 16px;
            font-size: 1.3rem;
            font-weight: 700;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            cursor: pointer;
            transition: var(--transition);
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
            letter-spacing: 0.5px;
        }
        
        .action-btn:disabled {
            background: linear-gradient(135deg, #adb5bd, #6c757d);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.6);
        }
        
        .action-btn.warning {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }
        
        .calendar {
            margin-top: 20px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day-label {
            font-size: 0.85rem;
            text-align: center;
            padding: 6px 0;
            font-weight: 600;
            color: var(--gray);
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            position: relative;
            transition: var(--transition);
            margin: 2px;
        }
        
        .calendar-day.today {
            background: rgba(67, 97, 238, 0.15);
            border: 2px solid var(--primary);
            font-weight: 700;
        }
        
        .calendar-day.checked {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success);
        }
        
        .calendar-day.reward {
            background: rgba(247, 37, 133, 0.2);
            color: var(--warning);
            position: relative;
        }
        
        .calendar-day.reward::after {
            content: "ğŸ";
            position: absolute;
            font-size: 10px;
            bottom: 2px;
            right: 2px;
        }
        
        .calendar-day.skipped {
            background: rgba(108, 117, 125, 0.2);
            text-decoration: line-through;
            color: var(--gray);
        }
        
        .calendar-day.skipped::after {
            content: "âœ“";
            position: absolute;
            font-size: 12px;
            color: var(--success);
        }
        
        .rewards-panel {
            margin-top: 20px;
        }
        
        .reward-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 14px;
            background: #f8f9fa;
            border-left: 3px solid var(--warning);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reward-info {
            flex: 1;
        }
        
        .reward-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .reward-cost {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--warning);
            text-align: right;
            min-width: 80px;
        }
        
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .backup-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .backup-btn.export {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .backup-btn.import {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        .backup-btn.reset {
            background: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }
        
        .warning {
            background: rgba(255, 243, 205, 0.5);
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 15px 0;
            border-radius: 0 12px 12px 0;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .version-info {
            text-align: center;
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        .modal-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
        }
        
        .modal-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 14px;
            font-size: 1.1rem;
            margin: 10px 0;
            transition: var(--transition);
        }
        
        .modal-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .modal-btn.cancel {
            background: #e9ecef;
            color: #495057;
        }
        
        .modal-btn.confirm {
            background: var(--primary);
            color: white;
        }
        
        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 480px) {
            .card {
                padding: 16px;
                border-radius: 14px;
            }
            
            .task {
                padding: 12px;
            }
            
            .task-name {
                font-size: 1.05rem;
            }
            
            .action-btn {
                padding: 14px;
                font-size: 1.2rem;
            }
            
            .score-value {
                font-size: 1.6rem;
            }
            
            .streak-value {
                font-size: 2.0rem;
            }
            
            .calendar-day {
                font-size: 13px;
            }
            
            .modal-content {
                padding: 20px 15px;
            }
            
            .modal-title {
                font-size: 1.4rem;
            }
            
            .modal-input {
                padding: 12px;
                font-size: 1rem;
            }
            
            .modal-btn {
                padding: 12px;
                font-size: 1rem;
            }
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-header">
            <div class="card-title">æˆé•¿æ‰“å¡ç³»ç»Ÿ</div>
            <button class="toggle-btn" id="toggleSettings">å±•å¼€è®¾ç½®</button>
        </div>
        
        <div class="streak-info">
            <div class="streak-value" id="streak">0</div>
            <div>è¿ç»­æ‰“å¡å¤©æ•°</div>
        </div>
        
        <div class="score-display">
            <div class="score-item">
                <div class="score-value" id="todayScore">0</div>
                <div class="score-label">ä»Šæ—¥å¾—åˆ†</div>
            </div>
            <div class="score-item">
                <div class="score-value" id="totalScore">0</div>
                <div class="score-label">æ€»ç§¯åˆ†</div>
            </div>
        </div>
        
        <div class="score-bar">
            <div class="score-progress" id="scoreProgress" style="width: 0%"></div>
        </div>
        
        <div id="taskList">
            <!-- ä»»åŠ¡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <button class="action-btn pulse" id="checkInBtn">ğŸ¯ ä»Šæ—¥æ‰“å¡</button>
        
        <div class="rewards-panel">
            <div class="config-title">ğŸ ç§¯åˆ†å•†åŸ</div>
            <div id="rewardsList">
                <!-- å¥–åŠ±å•†å“å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="action-btn success" id="useRewardBtn" disabled>å…‘æ¢å•†å“</button>
        </div>
        
        <div class="settings-section" id="settingsSection">
            <div class="warning">
                âš ï¸ <strong>é‡è¦æç¤ºï¼š</strong> ä¿®æ”¹é…ç½®åç‚¹å‡»"ä¿å­˜é…ç½®"ç”Ÿæ•ˆã€‚å†å²è®°å½•ä¼šä¿ç•™ï¼Œä½†ä½¿ç”¨æ–°è§„åˆ™çš„æ—¥æœŸä¼šç”¨ä¸åŒé¢œè‰²åŒºåˆ†ã€‚
            </div>
            
            <div class="config-group">
                <div class="config-title">ğŸ“ æ¯æ—¥ä»»åŠ¡è®¾ç½®</div>
                <p style="color: var(--gray); font-size: 0.95rem; margin-bottom: 8px;">
                    æ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ ¼å¼ï¼š<strong>ä»»åŠ¡åç§°|æè¿°</strong>ï¼ˆæè¿°å¯é€‰ï¼‰
                </p>
                <textarea id="tasksConfig" placeholder="æ•°å­¦å­¦ä¹ |ä¸“æ³¨å­¦ä¹ ï¼Œä¸è®¡é‡æ—¶é•¿
å•è¯å¬åŠ›|æ¥è§¦è‹±è¯­ï¼Œä¸è®¡é‡æ•°é‡
æœŸæœ«å¤ä¹ |å¤ä¹ é‡ç‚¹ï¼Œä¸è®¡é‡é¡µæ•°
æ— æ°§è¿åŠ¨|é€‚å½“é”»ç‚¼ï¼Œä¸è®¡é‡å¼ºåº¦
æ—©èµ·|è‡ªç„¶é†’æ¥ï¼Œä¸è®¡é‡æ—¶é—´">æ•°å­¦å­¦ä¹ |ä¸“æ³¨å­¦ä¹ ï¼Œä¸è®¡é‡æ—¶é•¿
å•è¯å¬åŠ›|æ¥è§¦è‹±è¯­ï¼Œä¸è®¡é‡æ•°é‡
æœŸæœ«å¤ä¹ |å¤ä¹ é‡ç‚¹ï¼Œä¸è®¡é‡é¡µæ•°
æ— æ°§è¿åŠ¨|é€‚å½“é”»ç‚¼ï¼Œä¸è®¡é‡å¼ºåº¦
æ—©èµ·|è‡ªç„¶é†’æ¥ï¼Œä¸è®¡é‡æ—¶é—´</textarea>
            </div>
            
            <div class="config-group">
                <div class="config-title">ğŸ“Š ç§¯åˆ†è§„åˆ™è®¾ç½®</div>
                <p style="color: var(--gray); font-size: 0.95rem; margin-bottom: 8px;">
                    æ¯å¤©æ€»åˆ†ä¸º<span style="color: var(--primary); font-weight: 700;">100åˆ†</span>ï¼Œæ ¹æ®å®Œæˆä»»åŠ¡æ•°å¹³å‡åˆ†é…<br>
                    æœ€ä½æ‰“å¡åˆ†æ•°ï¼š<input type="number" id="minScoreForCheckin" value="60" min="1" max="100" style="width: 60px; padding: 4px; border-radius: 6px; border: 1px solid #ddd;">åˆ†
                </p>
            </div>
            
            <div class="config-group">
                <div class="config-title">ğŸ å¥–åŠ±å•†å“è®¾ç½®</div>
                <p style="color: var(--gray); font-size: 0.95rem; margin-bottom: 8px;">
                    æ ¼å¼ï¼š<strong>å•†å“åç§°|æ‰€éœ€ç§¯åˆ†|æ•ˆæœæè¿°</strong>
                </p>
                <textarea id="rewardsConfig" placeholder="ä¼‘æ¯ä¸€å¤©|1000|è·³è¿‡ä»Šæ—¥æ‰“å¡ï¼Œä¸ä¸­æ–­è¿ç»­è®°å½•
å°å¨±ä¹|500|1å°æ—¶è‡ªç”±å¨±ä¹æ—¶é—´
ç¾é£Ÿå¥–åŠ±|800|50å…ƒç¾é£Ÿé¢„ç®—
å­¦ä¹ èµ„æ–™|1500|è´­ä¹°å­¦ä¹ ç›¸å…³èµ„æ–™">ä¼‘æ¯ä¸€å¤©|1000|è·³è¿‡ä»Šæ—¥æ‰“å¡ï¼Œä¸ä¸­æ–­è¿ç»­è®°å½•
å°å¨±ä¹|500|1å°æ—¶è‡ªç”±å¨±ä¹æ—¶é—´
ç¾é£Ÿå¥–åŠ±|800|50å…ƒç¾é£Ÿé¢„ç®—
å­¦ä¹ èµ„æ–™|1500|è´­ä¹°å­¦ä¹ ç›¸å…³èµ„æ–™</textarea>
            </div>
            
            <div class="config-group">
                <div class="config-title">âš ï¸ æƒ©ç½šè§„åˆ™è®¾ç½®</div>
                <p style="color: var(--gray); font-size: 0.95rem; margin-bottom: 8px;">
                    æ ¼å¼ï¼š<strong>ç¼ºå¸­å¤©æ•°|æ‰£é™¤ç§¯åˆ†|æƒ©ç½šæè¿°</strong>
                </p>
                <textarea id="punishmentsConfig" placeholder="1|-100|ä¸€å¤©æœªæ‰“å¡
2|-200|ä¸¤å¤©æœªæ‰“å¡
3|-400|ä¸‰å¤©æœªæ‰“å¡ï¼Œè¿ç»­è®°å½•ä¸­æ–­">1|-100|ä¸€å¤©æœªæ‰“å¡
2|-200|ä¸¤å¤©æœªæ‰“å¡
3|-400|ä¸‰å¤©æœªæ‰“å¡ï¼Œè¿ç»­è®°å½•ä¸­æ–­</textarea>
            </div>
            
            <button class="action-btn" id="saveConfigBtn" style="margin-top: 15px;">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</button>
        </div>
    </div>
    
    <div class="card calendar">
        <div class="card-header">
            <div class="card-title">ğŸ“… æ‰“å¡æ—¥å†</div>
            <div>
                <button class="toggle-btn" id="prevMonth" style="margin-right: 8px;">â®</button>
                <button class="toggle-btn" id="nextMonth">â¯</button>
            </div>
        </div>
        <div id="monthYear" style="text-align: center; font-weight: 600; margin: 10px 0; color: var(--primary);"></div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- æ—¥å†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="display: flex; justify-content: space-around; margin-top: 15px; font-size: 0.9rem;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 16px; height: 16px; background: rgba(76, 201, 240, 0.3); border-radius: 4px;"></div>
                <span>å·²æ‰“å¡</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 16px; height: 16px; background: rgba(247, 37, 133, 0.3); border-radius: 4px; position: relative;">
                    <span style="position: absolute; font-size: 8px; bottom: -2px; right: -2px;">ğŸ</span>
                </div>
                <span>å¥–åŠ±æ—¥</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 16px; height: 16px; background: rgba(108, 117, 125, 0.3); border-radius: 4px; text-decoration: line-through;"></div>
                <span>è·³è¿‡</span>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">ğŸ’¾ æ•°æ®ç®¡ç†</div>
        </div>
        
        <div class="backup-buttons">
            <button class="backup-btn export" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
            <button class="backup-btn import" onclick="importData()">å¯¼å…¥æ•°æ®</button>
            <button class="backup-btn reset" onclick="resetData()">é‡ç½®æ•°æ®</button>
        </div>
        
        <button class="action-btn warning" id="adjustPointsBtn" style="margin-top: 15px;">
            âœï¸ æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ†
        </button>
        
        <div class="warning">
            ğŸ”‘ <strong>å‡çº§æç¤ºï¼š</strong> æœªæ¥å‡çº§ä»£ç æ—¶ï¼Œ<strong>å…ˆå¯¼å‡ºæ•°æ®</strong>ï¼Œå‡çº§åå†å¯¼å…¥ï¼Œå¯ç¡®ä¿æ‰€æœ‰è®°å½•å’Œé…ç½®ä¸ä¸¢å¤±ã€‚
        </div>
        
        <div class="version-info">
            å½“å‰ç‰ˆæœ¬: <span id="dataVersion">3.0</span> | 
            ä»»åŠ¡ç‰ˆæœ¬: <span id="taskVersion">v1</span> | 
            æœ€åå¤‡ä»½: <span id="lastBackup">ä»æœª</span>
        </div>
    </div>
    
    <!-- ç§¯åˆ†è°ƒæ•´æ¨¡æ€æ¡† -->
    <div class="modal" id="adjustPointsModal">
        <div class="modal-content">
            <div class="modal-title">âœï¸ è°ƒæ•´ç§¯åˆ†</div>
            <input type="number" class="modal-input" id="pointsAdjustment" placeholder="è¾“å…¥ç§¯åˆ†å˜åŒ– (æ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘)">
            <div style="color: var(--gray); font-size: 0.95rem; margin: 8px 0; text-align: center;">
                å½“å‰æ€»ç§¯åˆ†: <span id="currentTotalPoints">0</span>
            </div>
            <textarea class="modal-input" id="adjustmentReason" placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå›  (ä¾‹å¦‚: å…‘æ¢ä¼‘æ¯ä¸€å¤©ã€æ‰‹åŠ¨ä¿®æ­£ç­‰)" style="min-height: 80px; resize: vertical;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelAdjustment">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="confirmAdjustment">ç¡®è®¤è°ƒæ•´</button>
            </div>
        </div>
    </div>
    
    <!-- å…‘æ¢ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="redeemModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ å…‘æ¢å•†å“</div>
            <div style="text-align: center; margin: 15px 0; font-size: 1.2rem; font-weight: 700;">
                é€‰æ‹©å•†å“: <span id="selectedRewardName">ä¼‘æ¯ä¸€å¤©</span>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin: 15px 0;">
                <div style="font-weight: 600; color: var(--dark); margin-bottom: 8px;">æ•ˆæœè¯´æ˜:</div>
                <div id="rewardEffect" style="color: var(--gray); line-height: 1.5;">
                    è·³è¿‡ä»Šæ—¥æ‰“å¡ï¼Œä¸ä¸­æ–­è¿ç»­è®°å½•
                </div>
            </div>
            <div style="text-align: center; font-weight: 700; font-size: 1.3rem; color: var(--warning); margin: 15px 0;">
                æ‰€éœ€ç§¯åˆ†: <span id="rewardCost">1000</span>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelRedeem">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="confirmRedeem" style="background: var(--warning);">ç¡®è®¤å…‘æ¢</button>
            </div>
        </div>
    </div>

    <script>
        // =============== ç³»ç»Ÿæ ¸å¿ƒé…ç½® ===============
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ - é‡è¦ã€‘
        // 1. æ­¤å¯¹è±¡åŒ…å«ç³»ç»Ÿæ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå‡çº§æ—¶å¿…é¡»ä¿ç•™
        // 2. æ–°å¢å­—æ®µåº”æ”¾åœ¨æœ«å°¾ï¼Œå¹¶è®¾ç½®é»˜è®¤å€¼
        // 3. ä¸è¦åˆ é™¤æˆ–é‡å‘½åç°æœ‰å­—æ®µï¼Œä»¥å…æ•°æ®ä¸¢å¤±
        // 4. ç‰ˆæœ¬å·å‡çº§è§„åˆ™ï¼š
        //    - systemVersion: åŠŸèƒ½é‡å¤§å˜åŒ–æ—¶å‡çº§
        //    - dataStructureVersion: æ•°æ®ç»“æ„å˜åŒ–æ—¶å‡çº§
        //    - configVersion: é…ç½®æ ¼å¼å˜åŒ–æ—¶å‡çº§
        const SYSTEM_META = {
            systemVersion: "3.0",       // ç³»ç»ŸåŠŸèƒ½ç‰ˆæœ¬
            dataStructureVersion: "3.0", // æ•°æ®ç»“æ„ç‰ˆæœ¬
            configVersion: "2.0"        // é…ç½®æ ¼å¼ç‰ˆæœ¬
        };
        
        // å½“å‰æŸ¥çœ‹çš„æœˆä»½
        let currentViewDate = new Date();
        
        // =============== æ•°æ®åŠ è½½ä¸ä¿å­˜ ===============
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°è´Ÿè´£æ•°æ®å­˜å‚¨ï¼Œå‡çº§æ—¶ä¸åº”æ”¹å˜å­˜å‚¨é”®å
        // 2. ä¿æŒlocalStorageé”®åä¸å˜ï¼š'habitData'
        // 3. æ–°å¢æ•°æ®å­—æ®µæ—¶ï¼Œç¡®ä¿å­˜å‚¨å‰è¿›è¡Œå…¼å®¹æ€§å¤„ç†
        function loadData() {
            const saved = localStorage.getItem('habitData');
            
            if (!saved) {
                return createDefaultData();
            }
            
            try {
                const data = JSON.parse(saved);
                return migrateData(data);
            } catch (e) {
                console.error("æ•°æ®è§£æé”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®", e);
                return createDefaultData();
            }
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. åˆ›å»ºé»˜è®¤æ•°æ®ç»“æ„ï¼Œå‡çº§æ—¶å¯ä¿®æ”¹é»˜è®¤å€¼
        // 2. ä¸è¦åˆ é™¤ç°æœ‰å­—æ®µï¼Œå¯æ·»åŠ æ–°å­—æ®µ
        function createDefaultData() {
            const today = new Date().toISOString().split('T')[0];
            
            return {
                // ã€å…ƒæ•°æ® - å…³é”®å‡çº§ç‚¹ã€‘
                systemMeta: { ...SYSTEM_META },
                
                // ã€ä¸ªäººèµ„æ–™ã€‘
                userProfile: {
                    name: "æˆé•¿è€…",
                    joinDate: today
                },
                
                // ã€ä»»åŠ¡é…ç½®ã€‘
                tasks: [
                    { name: "æ•°å­¦å­¦ä¹ ", desc: "ä¸“æ³¨å­¦ä¹ ï¼Œä¸è®¡é‡æ—¶é•¿", active: true },
                    { name: "å•è¯å¬åŠ›", desc: "æ¥è§¦è‹±è¯­ï¼Œä¸è®¡é‡æ•°é‡", active: true },
                    { name: "æœŸæœ«å¤ä¹ ", desc: "å¤ä¹ é‡ç‚¹ï¼Œä¸è®¡é‡é¡µæ•°", active: true },
                    { name: "æ— æ°§è¿åŠ¨", desc: "é€‚å½“é”»ç‚¼ï¼Œä¸è®¡é‡å¼ºåº¦", active: true },
                    { name: "æ—©èµ·", desc: "è‡ªç„¶é†’æ¥ï¼Œä¸è®¡é‡æ—¶é—´", active: true }
                ],
                
                // ã€ç§¯åˆ†è§„åˆ™ã€‘
                scoringRules: {
                    totalPoints: 100,           // æ¯æ—¥æ€»åˆ†
                    minScoreForCheckin: 60,     // æœ€ä½æ‰“å¡åˆ†æ•°
                    lastUpdated: today
                },
                
                // ã€å¥–åŠ±å•†å“ã€‘
                rewards: [
                    { name: "ä¼‘æ¯ä¸€å¤©", cost: 1000, effect: "è·³è¿‡ä»Šæ—¥æ‰“å¡ï¼Œä¸ä¸­æ–­è¿ç»­è®°å½•", enabled: true },
                    { name: "å°å¨±ä¹", cost: 500, effect: "1å°æ—¶è‡ªç”±å¨±ä¹æ—¶é—´", enabled: true },
                    { name: "ç¾é£Ÿå¥–åŠ±", cost: 800, effect: "50å…ƒç¾é£Ÿé¢„ç®—", enabled: true },
                    { name: "å­¦ä¹ èµ„æ–™", cost: 1500, effect: "è´­ä¹°å­¦ä¹ ç›¸å…³èµ„æ–™", enabled: true }
                ],
                
                // ã€æƒ©ç½šè§„åˆ™ã€‘
                punishments: [
                    { missedDays: 1, points: -100, desc: "ä¸€å¤©æœªæ‰“å¡" },
                    { missedDays: 2, points: -200, desc: "ä¸¤å¤©æœªæ‰“å¡" },
                    { missedDays: 3, points: -400, desc: "ä¸‰å¤©æœªæ‰“å¡ï¼Œè¿ç»­è®°å½•ä¸­æ–­" }
                ],
                
                // ã€ä»Šæ—¥çŠ¶æ€ã€‘
                today: {
                    date: today,
                    completedTasks: [],
                    score: 0,
                    checkedIn: false,
                    skipped: false,
                    skipReason: ""
                },
                
                // ã€å†å²è®°å½•ã€‘
                history: [],
                
                // ã€ç»Ÿè®¡æ•°æ®ã€‘
                stats: {
                    streak: 0,           // è¿ç»­æ‰“å¡å¤©æ•°
                    totalScore: 0,       // æ€»ç§¯åˆ†
                    lastCheckIn: null,   // æœ€åæ‰“å¡æ—¥æœŸ
                    lastResetDate: today // æœ€åé‡ç½®æ—¥æœŸ
                },
                
                // ã€ä»»åŠ¡ç‰ˆæœ¬ - å…³é”®å­—æ®µã€‘
                taskVersion: "v1", // ç”¨äºåŒºåˆ†å†å²è®°å½•çš„ä»»åŠ¡ç‰ˆæœ¬
                
                // ã€è°ƒæ•´è®°å½•ã€‘
                adjustments: [], // æ‰‹åŠ¨ç§¯åˆ†è°ƒæ•´è®°å½•
                
                // ã€å¤‡ä»½ä¿¡æ¯ã€‘
                lastBackupDate: null,
                
                // ã€æ‰©å±•å­—æ®µ - ä¸ºæœªæ¥å‡çº§é¢„ç•™ã€‘
                extensions: {
                    // æœªæ¥åŠŸèƒ½å¯æ·»åŠ åœ¨è¿™é‡Œ
                    // ä¾‹å¦‚: aiSuggestions: [], learningTopics: []
                }
            };
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°è´Ÿè´£æ•°æ®è¿ç§»ï¼Œå¤„ç†æ—§ç‰ˆæœ¬æ•°æ®
        // 2. æ¯æ¬¡å‡çº§æ—¶ï¼Œæ·»åŠ æ–°çš„è¿ç§»é€»è¾‘
        // 3. ä¿ç•™æ‰€æœ‰æ—§è¿ç§»é€»è¾‘ï¼Œç¡®ä¿å…¼å®¹æ‰€æœ‰å†å²ç‰ˆæœ¬
        function migrateData(data) {
            console.log("å¼€å§‹æ•°æ®è¿ç§»...");
            
            // ã€è¿ç§»è§„åˆ™1ã€‘å¦‚æœæ•°æ®æ²¡æœ‰systemMetaï¼Œå®ƒæ˜¯v1.0
            if (!data.systemMeta) {
                console.log("è¿ç§»æ—§ç‰ˆæ•°æ® (v1.0)");
                
                // åˆ›å»ºå…ƒæ•°æ®
                data.systemMeta = {
                    systemVersion: "1.0",
                    dataStructureVersion: "1.0",
                    configVersion: "1.0"
                };
                
                // è¿ç§»ä»Šæ—¥çŠ¶æ€
                if (!data.today) {
                    data.today = {
                        date: new Date().toISOString().split('T')[0],
                        completedTasks: [],
                        score: 0,
                        checkedIn: data.todayChecked || false,
                        skipped: false,
                        skipReason: ""
                    };
                }
                
                // è¿ç§»ç»Ÿè®¡æ•°æ®
                if (!data.stats) {
                    data.stats = {
                        streak: data.streak || 0,
                        totalScore: data.totalScore || 0,
                        lastCheckIn: data.lastCheckIn,
                        lastResetDate: data.lastResetDate || new Date().toISOString().split('T')[0]
                    };
                }
                
                // æ·»åŠ ç¼ºå¤±å­—æ®µ
                if (!data.adjustments) data.adjustments = [];
                if (!data.taskVersion) data.taskVersion = "v1";
                if (!data.extensions) data.extensions = {};
            }
            
            // ã€è¿ç§»è§„åˆ™2ã€‘v1.0 åˆ° v2.0 - æ·»åŠ å¥–åŠ±å’Œæƒ©ç½šç³»ç»Ÿ
            if (data.systemMeta.dataStructureVersion === "1.0") {
                console.log("è¿ç§»æ•°æ® v1.0 -> v2.0");
                
                if (!data.rewards) {
                    data.rewards = [
                        { name: "ä¼‘æ¯ä¸€å¤©", cost: 1000, effect: "è·³è¿‡ä»Šæ—¥æ‰“å¡ï¼Œä¸ä¸­æ–­è¿ç»­è®°å½•", enabled: true },
                        { name: "å°å¨±ä¹", cost: 500, effect: "1å°æ—¶è‡ªç”±å¨±ä¹æ—¶é—´", enabled: true }
                    ];
                }
                
                if (!data.punishments) {
                    data.punishments = [
                        { missedDays: 1, points: -100, desc: "ä¸€å¤©æœªæ‰“å¡" },
                        { missedDays: 2, points: -200, desc: "ä¸¤å¤©æœªæ‰“å¡" }
                    ];
                }
                
                data.systemMeta.dataStructureVersion = "2.0";
            }
            
            // ã€è¿ç§»è§„åˆ™3ã€‘v2.0 åˆ° v3.0 - ä¼˜åŒ–ç§¯åˆ†è§„åˆ™
            if (data.systemMeta.dataStructureVersion === "2.0") {
                console.log("è¿ç§»æ•°æ® v2.0 -> v3.0");
                
                if (!data.scoringRules) {
                    data.scoringRules = {
                        totalPoints: 100,
                        minScoreForCheckin: 60,
                        lastUpdated: new Date().toISOString().split('T')[0]
                    };
                }
                
                data.systemMeta.dataStructureVersion = "3.0";
                data.systemMeta.systemVersion = "3.0";
                data.systemMeta.configVersion = "2.0";
            }
            
            // ã€å®Œæ•´æ€§æ£€æŸ¥ã€‘
            ensureDataIntegrity(data);
            return data;
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°ç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼Œå‡çº§æ—¶åº”æ›´æ–°
        // 2. æ·»åŠ æ–°å­—æ®µæ—¶ï¼Œåœ¨æ­¤å¤„è®¾ç½®é»˜è®¤å€¼
        // 3. ä¸è¦åˆ é™¤ç°æœ‰å­—æ®µçš„éªŒè¯é€»è¾‘
        function ensureDataIntegrity(data) {
            // éªŒè¯ä»»åŠ¡
            if (!data.tasks || !Array.isArray(data.tasks)) {
                data.tasks = createDefaultData().tasks;
            }
            
            // éªŒè¯ç§¯åˆ†è§„åˆ™
            if (!data.scoringRules) {
                data.scoringRules = {
                    totalPoints: 100,
                    minScoreForCheckin: 60,
                    lastUpdated: new Date().toISOString().split('T')[0]
                };
            }
            
            // éªŒè¯å¥–åŠ±
            if (!data.rewards || !Array.isArray(data.rewards)) {
                data.rewards = createDefaultData().rewards;
            }
            
            // éªŒè¯æƒ©ç½š
            if (!data.punishments || !Array.isArray(data.punishments)) {
                data.punishments = createDefaultData().punishments;
            }
            
            // éªŒè¯ä»Šæ—¥çŠ¶æ€
            const today = new Date().toISOString().split('T')[0];
            if (!data.today || data.today.date !== today) {
                data.today = {
                    date: today,
                    completedTasks: [],
                    score: 0,
                    checkedIn: false,
                    skipped: false,
                    skipReason: ""
                };
            }
            
            // éªŒè¯ç»Ÿè®¡æ•°æ®
            if (!data.stats) {
                data.stats = {
                    streak: 0,
                    totalScore: 0,
                    lastCheckIn: null,
                    lastResetDate: today
                };
            }
            
            // ç¡®ä¿ä»»åŠ¡ç‰ˆæœ¬
            if (!data.taskVersion) {
                data.taskVersion = generateTaskVersion(data.tasks);
            }
            
            // ç¡®ä¿è°ƒæ•´è®°å½•
            if (!data.adjustments) {
                data.adjustments = [];
            }
            
            // ç¡®ä¿æ‰©å±•å­—æ®µ
            if (!data.extensions) {
                data.extensions = {};
            }
            
            return data;
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°ä¿å­˜æ•°æ®ï¼Œä¸è¦ä¿®æ”¹å­˜å‚¨é”®å
        // 2. å‡çº§æ—¶å¦‚éœ€æ”¹å˜å­˜å‚¨ç»“æ„ï¼Œå…ˆè¿ç§»æ•°æ®å†ä¿å­˜
        // 3. ä¿æŒlocalStorageé”®åä¸å˜ï¼š'habitData'
        function saveData(data) {
            localStorage.setItem('habitData', JSON.stringify(data));
        }


        // =============== ä»»åŠ¡ä¸ç‰ˆæœ¬ç®¡ç† ===============
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°ç”Ÿæˆä»»åŠ¡ç‰ˆæœ¬IDï¼Œç”¨äºåŒºåˆ†ä¸åŒä»»åŠ¡é…ç½®
        // 2. ç®—æ³•å˜æ›´ä¼šå½±å“å†å²è®°å½•é¢œè‰²åŒºåˆ†ï¼Œå‡çº§æ—¶æ…é‡
        // 3. ä¿æŒç®—æ³•ç®€å•ç¨³å®šï¼ŒåŸºäºä»»åŠ¡åç§°å’Œæ•°é‡
        function generateTaskVersion(tasks) {
            const taskNames = tasks.map(t => t.name).sort().join('|');
            return 'v' + (taskNames.length * tasks.length).toString(36);
        }
        
        // =============== æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ===============
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°æ¯æ—¥é‡ç½®ä»»åŠ¡ï¼Œå…³é”®åŠŸèƒ½
        // 2. é€»è¾‘ä¸åº”æ”¹å˜ï¼šå½“æ—¥æœŸå˜åŒ–æ—¶é‡ç½®
        // 3. å‡çº§æ—¶å¦‚éœ€ä¿®æ”¹é‡ç½®é€»è¾‘ï¼Œåœ¨æ­¤å¤„è°ƒæ•´
        function resetDailyTasks() {
            const data = loadData();
            const today = new Date().toISOString().split('T')[0];
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©
            if (data.today.date !== today) {
                console.log(`ğŸ”„ æ¯æ—¥é‡ç½®: ${data.today.date} -> ${today}`);
                
                // ä¿å­˜æ˜¨æ—¥è®°å½•ï¼ˆå¦‚æœå·²æ‰“å¡ï¼‰
                if (data.today.checkedIn || data.today.skipped) {
                    data.history.push({
                        ...data.today,
                        taskVersion: data.taskVersion,
                        type: data.today.skipped ? 'skipped' : 'checked'
                    });
                }
                
                // é‡ç½®ä»Šæ—¥çŠ¶æ€
                data.today = {
                    date: today,
                    completedTasks: [],
                    score: 0,
                    checkedIn: false,
                    skipped: false,
                    skipReason: ""
                };
                
                // æ£€æŸ¥æ˜¯å¦ä¸­æ–­è¿ç»­è®°å½•
                if (data.stats.lastCheckIn) {
                    const lastCheckInDate = new Date(data.stats.lastCheckIn);
                    const todayDate = new Date(today);
                    const diffDays = Math.floor((todayDate - lastCheckInDate) / (1000 * 60 * 60 * 24));
                    
                    // åº”ç”¨æƒ©ç½šï¼ˆå¦‚æœæœªæ‰“å¡å¤©æ•°ç¬¦åˆæƒ©ç½šè§„åˆ™ï¼‰
                    if (diffDays > 1) {
                        const punishment = data.punishments.find(p => p.missedDays === diffDays);
                        if (punishment) {
                            data.stats.totalScore += punishment.points;
                            console.log(`âš ï¸ åº”ç”¨æƒ©ç½š: ${punishment.desc}, ${punishment.points}åˆ†`);
                        }
                    }
                }
                
                // ä¿å­˜å¹¶é‡æ–°æ¸²æŸ“
                saveData(data);
                renderAll();
                return true;
            }
            return false;
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°å¤„ç†ä»»åŠ¡åˆ‡æ¢ï¼Œæ ¸å¿ƒåŠŸèƒ½
        // 2. ä¸è¦æ”¹å˜å‚æ•°ç­¾åï¼štoggleTask(index)
        // 3. ä¸šåŠ¡è§„åˆ™é€šè¿‡é…ç½®å®ç°ï¼Œæ­¤å¤„ä¿æŒç®€å•
        function toggleTask(index) {
            const data = loadData();
            
            if (data.today.checkedIn || data.today.skipped) return;
            
            const taskId = `task${index}`;
            const taskIndex = data.today.completedTasks.indexOf(taskId);
            
            if (taskIndex > -1) {
                data.today.completedTasks.splice(taskIndex, 1);
            } else {
                data.today.completedTasks.push(taskId);
            }
            
            // é‡æ–°è®¡ç®—åˆ†æ•°
            updateTodayScore(data);
            
            saveData(data);
            renderTasks();
            updateScoreDisplay();
            checkCheckinAvailability();
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°æ›´æ–°ä»Šæ—¥åˆ†æ•°ï¼Œç‹¬ç«‹é€»è¾‘ä¾¿äºå‡çº§
        // 2. åŸºäºä»»åŠ¡å®Œæˆæ¯”ä¾‹è®¡ç®—ï¼Œæ€»åˆ†100åˆ†
        function updateTodayScore(data) {
            const completedCount = data.today.completedTasks.length;
            const totalTasks = data.tasks.filter(t => t.active).length;
            
            if (totalTasks === 0) {
                data.today.score = 0;
                return;
            }
            
            // æŒ‰æ¯”ä¾‹è®¡ç®—åˆ†æ•°
            const score = Math.round((completedCount / totalTasks) * data.scoringRules.totalPoints);
            data.today.score = score;
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°æ£€æŸ¥æ‰“å¡æŒ‰é’®çŠ¶æ€
        function checkCheckinAvailability() {
            const data = loadData();
            const btn = document.getElementById('checkInBtn');
            const useRewardBtn = document.getElementById('useRewardBtn');
            
            if (data.today.checkedIn) {
                btn.disabled = true;
                btn.textContent = 'âœ… ä»Šæ—¥å·²æ‰“å¡';
                btn.classList.remove('pulse');
            } else if (data.today.skipped) {
                btn.disabled = true;
                btn.textContent = `â­ï¸ ä»Šæ—¥å·²è·³è¿‡: ${data.today.skipReason}`;
                btn.classList.remove('pulse');
            } else if (data.today.score < data.scoringRules.minScoreForCheckin) {
                btn.disabled = true;
                btn.textContent = `è¿˜éœ€ ${data.scoringRules.minScoreForCheckin - data.today.score} åˆ†æ‰èƒ½æ‰“å¡`;
                btn.classList.remove('pulse');
            } else {
                btn.disabled = false;
                btn.textContent = 'ğŸ¯ ä»Šæ—¥æ‰“å¡';
                btn.classList.add('pulse');
            }
            
            // æ£€æŸ¥å¥–åŠ±æŒ‰é’®çŠ¶æ€
            const hasAvailableRewards = data.rewards.some(r => 
                r.enabled && data.stats.totalScore >= r.cost
            );
            useRewardBtn.disabled = !hasAvailableRewards || data.today.checkedIn || data.today.skipped;
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°å¤„ç†ä»Šæ—¥æ‰“å¡ï¼Œæ ¸å¿ƒä¸šåŠ¡
        // 2. åŒ…å«è¿ç»­å¤©æ•°ã€ç§¯åˆ†ã€å†å²è®°å½•æ›´æ–°
        function completeToday() {
            const data = loadData();
            
            if (data.today.checkedIn || data.today.skipped || 
                data.today.score < data.scoringRules.minScoreForCheckin) {
                return;
            }
            
            // æ›´æ–°è¿ç»­å¤©æ•°
            const today = new Date().toISOString().split('T')[0];
            const lastCheckIn = data.stats.lastCheckIn ? new Date(data.stats.lastCheckIn) : null;
            
            if (lastCheckIn) {
                const diffTime = new Date(today) - lastCheckIn;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    // è¿ç»­æ‰“å¡
                    data.stats.streak++;
                } else if (diffDays > 1) {
                    // ä¸­æ–­è¿ç»­
                    data.stats.streak = 1;
                }
                // åŒä¸€å¤©ä¸æ”¹å˜
            } else {
                // é¦–æ¬¡æ‰“å¡
                data.stats.streak = 1;
            }
            
            // æ›´æ–°æ€»ç§¯åˆ†
            data.stats.totalScore += data.today.score;
            
            // æ ‡è®°ä»Šæ—¥å·²æ‰“å¡
            data.today.checkedIn = true;
            data.stats.lastCheckIn = today;
            
            // ä¿å­˜
            saveData(data);
            
            // é‡æ–°æ¸²æŸ“
            updateStreakInfo();
            renderTasks();
            updateScoreDisplay();
            renderCalendar();
            checkCheckinAvailability();
            
            showSuccessMessage(`âœ… æ‰“å¡æˆåŠŸï¼\nè·å¾— ${data.today.score} åˆ†\nå½“å‰è¿ç»­ ${data.stats.streak} å¤©`);
        }
        
        // ã€å‡çº§æ³¨æ„äº‹é¡¹ã€‘
        // 1. æ­¤å‡½æ•°å¤„ç†ä½¿ç”¨å¥–åŠ±ï¼Œæ ¸å¿ƒä¸šåŠ¡
        function useReward(reward) {
            const data = loadData();
            const today = new Date().toISOString().split('T')[0];
            
            // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
            if (data.stats.totalScore < reward.cost) {
                showWarningMessage('âš ï¸ ç§¯åˆ†ä¸è¶³ï¼', `éœ€è¦ ${reward.cost} ç§¯åˆ†ï¼Œå½“å‰åªæœ‰ ${data.stats.totalScore} ç§¯åˆ†`);
                return false;
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼šä¼‘æ¯ä¸€å¤©
            if (reward.name === "ä¼‘æ¯ä¸€å¤©") {
                // æ ‡è®°ä»Šæ—¥ä¸ºè·³è¿‡
                data.today.skipped = true;
                data.today.skipReason = "ä½¿ç”¨å¥–åŠ±: ä¼‘æ¯ä¸€å¤©";
                data.today.checkedIn = true; // ä¹Ÿç®—ä½œæ‰“å¡ï¼Œä¸ä¸­æ–­è¿ç»­è®°å½•
                
                // æ›´æ–°è¿ç»­å¤©æ•°ï¼ˆä¿æŒä¸å˜ï¼Œå› ä¸ºè·³è¿‡ä¹Ÿç®—å®Œæˆï¼‰
                if (!data.stats.lastCheckIn) {
                    data.stats.streak = 1;
                }
                
                // æ‰£é™¤ç§¯åˆ†
                data.stats.totalScore -= reward.cost;
                data.stats.lastCheckIn = today;
                
                // è®°å½•è°ƒæ•´
                data.adjustments.push({
                    date: today,
                    type: "reward_use",
                    points: -reward.cost,
                    reason: `å…‘æ¢å¥–åŠ±: ${reward.name}`,
                    before: data.stats.totalScore + reward.cost,
                    after: data.stats.totalScore
                });
                
                // ä¿å­˜
                saveData(data);
                
                // é‡æ–°æ¸²æŸ“
                updateStreakInfo();
                renderTasks();
                updateScoreDisplay();
                renderCalendar();
                checkCheckinAvailability();
                
                showSuccessMessage(`ğŸ‰ å¥–åŠ±å…‘æ¢æˆåŠŸï¼\nå·²è·³è¿‡ä»Šæ—¥æ‰“å¡\næ‰£é™¤ ${reward.cost} ç§¯åˆ†`);
                return true;
            }
            
            // å…¶ä»–å¥–åŠ±ç±»å‹ï¼ˆæœªæ¥æ‰©å±•ï¼‰
            data.stats.totalScore -= reward.cost;
            data.adjustments.push({
                date: today,
                type: "reward_use",
                points: -reward.cost,
                reason: `å…‘æ¢å¥–åŠ±: ${reward.name}`,
                before: data.stats.totalScore + reward.cost,
                after: data.stats.totalScore
            });
            
            saveData(data);
            updateScoreDisplay();
            showSuccessMessage(`ğŸ‰ å¥–åŠ±å…‘æ¢æˆåŠŸï¼\n${reward.effect}\næ‰£é™¤ ${reward.cost} ç§¯åˆ†`);
            return true;
        }
        
        // =============== UIæ¸²æŸ“ ===============
        function renderTasks() {
            const data = loadData();
            const container = document.getElementById('taskList');
            
            // è®¡ç®—ä»»åŠ¡å®Œæˆæ¯”ä¾‹
            const completedCount = data.today.completedTasks.length;
            const totalTasks = data.tasks.filter(t => t.active).length;
            const completionRate = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="config-title" style="margin: 0; font-size: 1.2rem;">âœ… ä»Šæ—¥ä»»åŠ¡ (${completedCount}/${totalTasks})</div>
                    <div style="background: rgba(67, 97, 238, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-weight: 600;">
                        ${completionRate}%
                    </div>
                </div>
            `;
            
            data.tasks
                .filter(task => task.active)
                .forEach((task, index) => {
                    const taskId = `task${index}`;
                    const isChecked = data.today.completedTasks.includes(taskId);
                    const isDisabled = data.today.checkedIn || data.today.skipped;
                    
                    html += `
                        <div class="task ${isChecked ? 'completed' : ''}" 
                             style="${isDisabled ? 'opacity: 0.7; pointer-events: none;' : ''}">
                            <div class="task-checkbox ${isChecked ? 'checked' : ''}" 
                                 data-index="${index}" 
                                 style="cursor: ${isDisabled ? 'not-allowed' : 'pointer'};">
                            </div>
                            <div class="task-content">
                                <div class="task-name">${task.name}</div>
                                <div class="task-desc">${task.desc}</div>
                            </div>
                        </div>
                    `;
                });
            
            container.innerHTML = html;
            
            // é‡æ–°ç»‘å®šä»»åŠ¡ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.task-checkbox').forEach(el => {
                el.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    toggleTask(index);
                });
            });
        }
        
        function updateScoreDisplay() {
            const data = loadData();
            document.getElementById('todayScore').textContent = data.today.score;
            document.getElementById('totalScore').textContent = data.stats.totalScore;
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = document.getElementById('scoreProgress');
            const percent = Math.min(100, (data.today.score / data.scoringRules.totalPoints) * 100);
            progress.style.width = `${percent}%`;
            
            // æ ¹æ®åˆ†æ•°æ”¹å˜é¢œè‰²
            if (data.today.score >= data.scoringRules.minScoreForCheckin) {
                progress.style.background = 'linear-gradient(90deg, #4CAF50, #2e7d32)';
            } else {
                progress.style.background = 'linear-gradient(90deg, #ff9800, #f57c00)';
            }
        }
        
        function updateStreakInfo() {
            const data = loadData();
            document.getElementById('streak').textContent = data.stats.streak;
        }
        
        function renderRewards() {
            const data = loadData();
            const container = document.getElementById('rewardsList');
            const today = new Date().toISOString().split('T')[0];
            
            // è·å–ä»Šæ—¥æ˜¯å¦å·²ä½¿ç”¨å¥–åŠ±
            const todayAdjustment = data.adjustments.find(a => 
                a.date === today && a.type === "reward_use"
            );
            
            let html = '';
            
            data.rewards
                .filter(reward => reward.enabled)
                .forEach((reward, index) => {
                    const canAfford = data.stats.totalScore >= reward.cost;
                    const isDisabled = data.today.checkedIn || data.today.skipped || !canAfford;
                    
                    html += `
                        <div class="reward-item ${isDisabled ? 'disabled' : ''}" 
                             data-index="${index}"
                             style="opacity: ${isDisabled ? '0.6' : '1'}; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};">
                            <div class="reward-info">
                                <div class="reward-name">${reward.name}</div>
                                <div style="color: var(--gray); font-size: 0.95rem; margin-top: 4px;">${reward.effect}</div>
                            </div>
                            <div class="reward-cost" style="color: ${canAfford ? '#f72585' : '#6c757d'};">
                                ${reward.cost}
                            </div>
                        </div>
                    `;
                });
            
            container.innerHTML = html || '<div style="text-align: center; color: var(--gray); padding: 15px;">æš‚æ— å¯ç”¨å¥–åŠ±</div>';
            
            // é‡æ–°ç»‘å®šå¥–åŠ±ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.reward-item').forEach(el => {
                el.addEventListener('click', function() {
                    if (data.today.checkedIn || data.today.skipped) return;
                    
                    const index = parseInt(this.getAttribute('data-index'));
                    const reward = data.rewards[index];
                    
                    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    showRedeemModal(reward);
                });
            });
        }
        
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthYearEl = document.getElementById('monthYear');
            grid.innerHTML = '';
            
            // è®¾ç½®æœˆä»½æ ‡é¢˜
            const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                              'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            monthYearEl.textContent = `${year}å¹´${monthNames[month]}`;
            
            // æ·»åŠ æ˜ŸæœŸæ ‡ç­¾
            ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(day => {
                const label = document.createElement('div');
                label.className = 'calendar-day-label';
                label.textContent = day;
                grid.appendChild(label);
            });
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            // å¡«å……ä¸Šä¸ªæœˆçš„ç©ºç™½
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }
            
            // è·å–æ•°æ®
            const data = loadData();
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const historyByDate = {};
            
            // æ•´åˆå†å²è®°å½•å’Œè°ƒæ•´è®°å½•
            [...data.history, ...data.adjustments].forEach(record => {
                if (!historyByDate[record.date]) {
                    historyByDate[record.date] = { records: [] };
                }
                historyByDate[record.date].records.push(record);
            });
            
            // å¡«å……å½“æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;
                
                // ä»Šå¤©
                if (date.toDateString() === today.toDateString()) {
                    dayEl.classList.add('today');
                }
                
                // æœ‰è®°å½•
                if (historyByDate[dateStr]) {
                    const records = historyByDate[dateStr].records;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å¡è®°å½•
                    const hasCheckin = records.some(r => r.checkedIn || r.type === 'checked');
                    const hasSkipped = records.some(r => r.skipped || (r.type === 'skipped'));
                    const hasReward = records.some(r => r.type === 'reward_use');
                    
                    if (hasSkipped) {
                        dayEl.classList.add('skipped');
                        dayEl.title = `è·³è¿‡: ${records.find(r => r.skipped)?.skipReason || 'ä½¿ç”¨å¥–åŠ±è·³è¿‡'}`;
                    } else if (hasCheckin) {
                        dayEl.classList.add('checked');
                        const score = records.find(r => r.checkedIn || r.type === 'checked')?.score || 0;
                        dayEl.title = `æ‰“å¡å¾—åˆ†: ${score}åˆ†`;
                    }
                    
                    if (hasReward) {
                        dayEl.classList.add('reward');
                        const rewardRecord = records.find(r => r.type === 'reward_use');
                        if (rewardRecord) {
                            dayEl.title += `\n${rewardRecord.reason}`;
                        }
                    }
                }
                
                // ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºæ—¥æœŸè¯¦æƒ…
                dayEl.addEventListener('click', function() {
                    if (date > today) return; // æœªæ¥æ—¥æœŸä¸æ˜¾ç¤ºè¯¦æƒ…
                    
                    const dateDetails = historyByDate[dateStr] || { records: [] };
                    showDateDetails(dateStr, dateDetails.records);
                });
                
                grid.appendChild(dayEl);
            }
        }
        
        // =============== é…ç½®ç®¡ç† ===============
        function loadConfigUI() {
            const data = loadData();
            
            // ä»»åŠ¡é…ç½®
            const tasksConfig = data.tasks
                .map(task => `${task.name}|${task.desc}`)
                .join('\n');
            document.getElementById('tasksConfig').value = tasksConfig;
            
            // ç§¯åˆ†è§„åˆ™
            document.getElementById('minScoreForCheckin').value = data.scoringRules.minScoreForCheckin;
            
            // å¥–åŠ±é…ç½®
            const rewardsConfig = data.rewards
                .map(reward => `${reward.name}|${reward.cost}|${reward.effect}`)
                .join('\n');
            document.getElementById('rewardsConfig').value = rewardsConfig;
            
            // æƒ©ç½šé…ç½®
            const punishmentsConfig = data.punishments
                .map(punishment => `${punishment.missedDays}|${punishment.points}|${punishment.desc}`)
                .join('\n');
            document.getElementById('punishmentsConfig').value = punishmentsConfig;
            
            // ç‰ˆæœ¬ä¿¡æ¯
            document.getElementById('dataVersion').textContent = data.systemMeta.systemVersion;
            document.getElementById('taskVersion').textContent = data.taskVersion;
            
            // å¤‡ä»½ä¿¡æ¯
            if (data.lastBackupDate) {
                document.getElementById('lastBackup').textContent = new Date(data.lastBackupDate).toLocaleDateString();
            }
        }
        
        function saveConfig() {
            const data = loadData();
            const oldTaskVersion = data.taskVersion;
            
            // 1. ä¿å­˜ä»»åŠ¡é…ç½®
            const tasksText = document.getElementById('tasksConfig').value.trim();
            const taskLines = tasksText.split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('//'));
            
            if (taskLines.length > 0) {
                const newTasks = taskLines.map(line => {
                    const [name, desc = 'å®Œæˆä»»åŠ¡'] = line.split('|').map(s => s.trim());
                    const existing = data.tasks.find(t => t.name === name);
                    return {
                        name: name,
                        desc: desc,
                        active: true
                    };
                });
                
                // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦çœŸæ­£æ”¹å˜
                const oldTasks = data.tasks.map(t => `${t.name}|${t.desc}`).sort().join('|');
                const newTasksStr = newTasks.map(t => `${t.name}|${t.desc}`).sort().join('|');
                
                if (oldTasks !== newTasksStr) {
                    data.tasks = newTasks;
                    data.taskVersion = generateTaskVersion(data.tasks);
                    
                    if (oldTaskVersion !== data.taskVersion) {
                        showToast(`ğŸ‰ ä»»åŠ¡å·²æ›´æ–°ï¼\næ–°ç‰ˆæœ¬: ${data.taskVersion}`);
                    }
                }
            }
            
            // 2. ä¿å­˜ç§¯åˆ†è§„åˆ™
            const minScore = parseInt(document.getElementById('minScoreForCheckin').value) || 60;
            data.scoringRules = {
                totalPoints: 100, // å›ºå®šä¸º100åˆ†
                minScoreForCheckin: Math.max(1, Math.min(100, minScore)), // é™åˆ¶åœ¨1-100ä¹‹é—´
                lastUpdated: new Date().toISOString().split('T')[0]
            };
            
            // 3. ä¿å­˜å¥–åŠ±é…ç½®
            const rewardsText = document.getElementById('rewardsConfig').value.trim();
            const rewardLines = rewardsText.split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('//'));
            
            if (rewardLines.length > 0) {
                data.rewards = rewardLines.map(line => {
                    const [name, costStr, effect] = line.split('|').map(s => s.trim());
                    const cost = parseInt(costStr) || 500;
                    return {
                        name: name,
                        cost: cost,
                        effect: effect || 'å…‘æ¢å¥–åŠ±',
                        enabled: true
                    };
                });
            }
            
            // 4. ä¿å­˜æƒ©ç½šé…ç½®
            const punishmentsText = document.getElementById('punishmentsConfig').value.trim();
            const punishmentLines = punishmentsText.split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('//'));
            
            if (punishmentLines.length > 0) {
                data.punishments = punishmentLines.map(line => {
                    const [daysStr, pointsStr, desc] = line.split('|').map(s => s.trim());
                    const missedDays = parseInt(daysStr) || 1;
                    const points = parseInt(pointsStr) || -100;
                    return {
                        missedDays: missedDays,
                        points: points,
                        desc: desc || `ç¼ºå¸­${missedDays}å¤©`
                    };
                });
            }
            
            // ä¿å­˜æ•°æ®
            saveData(data);
            
            // é‡æ–°æ¸²æŸ“
            renderAll();
            showToast("âœ… é…ç½®å·²ä¿å­˜ï¼æ‰€æœ‰è§„åˆ™å·²æ›´æ–°ã€‚");
        }
        
        // =============== UIå·¥å…·å‡½æ•° ===============
        function showToast(message, duration = 3000) {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'rgba(67, 97, 238, 0.95)';
            toast.style.color = 'white';
            toast.style.padding = '12px 25px';
            toast.style.borderRadius = '14px';
            toast.style.fontWeight = '600';
            toast.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
            toast.style.zIndex = '10000';
            toast.style.textAlign = 'center';
            toast.style.maxWidth = '80%';
            toast.innerHTML = message;
            
            document.body.appendChild(toast);
            
            // åŠ¨ç”»
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(20px)';
                toast.style.transition = 'all 0.3s ease';
            }, duration - 300);
            
            // ç§»é™¤
            setTimeout(() => {
                document.body.removeChild(toast);
            }, duration);
        }
        
        function showSuccessMessage(title, message = "") {
            alert(`${title}\n\n${message}`);
        }
        
        function showWarningMessage(title, message) {
            alert(`${title}\n\n${message}`);
        }
        
        function showDateDetails(dateStr, records) {
            if (records.length === 0) {
                alert(`ğŸ“… ${formatDateDisplay(dateStr)}\n\nä»Šæ—¥æ— è®°å½•`);
                return;
            }
            
            let details = `ğŸ“… ${formatDateDisplay(dateStr)}\n\n`;
            
            records.forEach(record => {
                if (record.checkedIn || record.type === 'checked') {
                    details += `âœ… æ‰“å¡æˆåŠŸ\n`;
                    details += `â­ è·å¾— ${record.score || 0} åˆ†\n`;
                    details += `ğŸ¯ å®Œæˆ ${record.completedTasks?.length || 0} é¡¹ä»»åŠ¡\n\n`;
                }
                
                if (record.skipped || record.type === 'skipped') {
                    details += `â­ï¸ ä»Šæ—¥è·³è¿‡\n`;
                    details += `ğŸ“ åŸå› : ${record.skipReason || 'ä½¿ç”¨å¥–åŠ±è·³è¿‡'}\n\n`;
                }
                
                if (record.type === 'reward_use') {
                    details += `ğŸ å…‘æ¢å¥–åŠ±\n`;
                    details += `ğŸ’° ${record.reason}\n`;
                    details += `ğŸ“Š ç§¯åˆ†å˜åŒ–: ${record.before} â†’ ${record.after}\n\n`;
                }
            });
            
            alert(details);
        }
        
        function formatDateDisplay(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }
        
        // =============== æ¨¡æ€æ¡†æ§åˆ¶ ===============
        function showRedeemModal(reward) {
            const modal = document.getElementById('redeemModal');
            document.getElementById('selectedRewardName').textContent = reward.name;
            document.getElementById('rewardEffect').textContent = reward.effect;
            document.getElementById('rewardCost').textContent = reward.cost;
            
            // å­˜å‚¨å½“å‰é€‰æ‹©çš„å¥–åŠ±
            modal.dataset.selectedReward = JSON.stringify(reward);
            
            modal.classList.add('active');
        }
        
        function showAdjustPointsModal() {
            const data = loadData();
            const modal = document.getElementById('adjustPointsModal');
            
            document.getElementById('currentTotalPoints').textContent = data.stats.totalScore;
            document.getElementById('pointsAdjustment').value = '';
            document.getElementById('adjustmentReason').value = '';
            
            modal.classList.add('active');
        }
        
        // =============== æ•°æ®ç®¡ç† ===============
        function exportData() {
            const data = loadData();
            const exportFileDefaultName = `growth-data-${new Date().toISOString().split('T')[0]}.json`;
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = exportFileDefaultName;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
            
            // æ›´æ–°å¤‡ä»½æ—¶é—´
            data.lastBackupDate = new Date().toISOString();
            saveData(data);
            document.getElementById('lastBackup').textContent = new Date().toLocaleDateString();
            
            showToast(`âœ… æ•°æ®å·²å¯¼å‡ºï¼\næ–‡ä»¶: ${exportFileDefaultName}`);
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (!importedData.tasks || !importedData.history) {
                            throw new Error('æ•°æ®æ ¼å¼æ— æ•ˆ');
                        }
                        
                        if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿ\nè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼\nå»ºè®®å…ˆå¤‡ä»½å½“å‰æ•°æ®ã€‚')) {
                            // ä¿å­˜å½“å‰æ•°æ®å¤‡ä»½
                            localStorage.setItem('habitDataBackupBeforeImport', localStorage.getItem('habitData'));
                            
                            // å¯¼å…¥æ•°æ®
                            localStorage.setItem('habitData', JSON.stringify(importedData));
                            
                            // é‡ç½®æœˆä»½è§†å›¾
                            currentViewDate = new Date();
                            
                            // é‡æ–°æ¸²æŸ“
                            renderAll();
                            loadConfigUI();
                            
                            showToast('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼\næ‰€æœ‰å†å²è®°å½•å·²æ¢å¤ã€‚');
                        }
                    } catch (error) {
                        showToast(`âŒ å¯¼å…¥å¤±è´¥: ${error.message}`);
                    }
                };
                reader.readAsText(file);
                input.value = null;
            };
            
            input.click();
        }
        
        function resetData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ\nè¿™å°†æ¸…é™¤æ‰€æœ‰æ‰“å¡è®°å½•ã€ç§¯åˆ†å’Œè®¾ç½®ï¼\nâš ï¸ è¯·ç¡®ä¿å·²å¯¼å‡ºé‡è¦æ•°æ® âš ï¸')) {
                localStorage.removeItem('habitData');
                currentViewDate = new Date();
                renderAll();
                loadConfigUI();
                showToast('âœ… æ•°æ®å·²é‡ç½®ï¼\nè¿”å›é»˜è®¤è®¾ç½®ã€‚');
            }
        }
        
        // =============== æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ† ===============
        function adjustPoints(points, reason) {
            const data = loadData();
            const today = new Date().toISOString().split('T')[0];
            
            // è®°å½•è°ƒæ•´
            const before = data.stats.totalScore;
            data.stats.totalScore += points;
            const after = data.stats.totalScore;
            
            data.adjustments.push({
                date: today,
                type: "manual_adjust",
                points: points,
                reason: reason,
                before: before,
                after: after
            });
            
            // ä¿å­˜
            saveData(data);
            
            // é‡æ–°æ¸²æŸ“
            updateScoreDisplay();
            renderCalendar();
            
            return true;
        }
        
        // =============== æœˆä»½å¯¼èˆª ===============
        function prevMonth() {
            currentViewDate.setMonth(currentViewDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentViewDate.setMonth(currentViewDate.getMonth() + 1);
            renderCalendar();
        }
        
        // =============== åˆå§‹åŒ– ===============
        function renderAll() {
            renderTasks();
            updateScoreDisplay();
            updateStreakInfo();
            renderRewards();
            renderCalendar();
            checkCheckinAvailability();
        }
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            // 1. æ¯æ—¥é‡ç½®æ£€æŸ¥
            resetDailyTasks();
            
            // 2. åŠ è½½é…ç½®UI
            loadConfigUI();
            
            // 3. åˆå§‹æ¸²æŸ“
            renderAll();
            
            // 4. äº‹ä»¶ç›‘å¬å™¨
            
            // è®¾ç½®é¢æ¿åˆ‡æ¢
            document.getElementById('toggleSettings').addEventListener('click', function() {
                const settingsSection = document.getElementById('settingsSection');
                const isActive = settingsSection.classList.contains('active');
                
                settingsSection.classList.toggle('active', !isActive);
                this.textContent = isActive ? 'å±•å¼€è®¾ç½®' : 'æŠ˜å è®¾ç½®';
                this.classList.toggle('active', !isActive);
            });
            
            // ä¿å­˜é…ç½®
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);
            
            // æ‰“å¡æŒ‰é’®
            document.getElementById('checkInBtn').addEventListener('click', completeToday);
            
            // å…‘æ¢æŒ‰é’®
            document.getElementById('useRewardBtn').addEventListener('click', function() {
                const data = loadData();
                const availableRewards = data.rewards.filter(r => 
                    r.enabled && data.stats.totalScore >= r.cost
                );
                
                if (availableRewards.length > 0) {
                    showRedeemModal(availableRewards[0]);
                }
            });
            
            // æœˆä»½å¯¼èˆª
            document.getElementById('prevMonth').addEventListener('click', prevMonth);
            document.getElementById('nextMonth').addEventListener('click', nextMonth);
            
            // ç§¯åˆ†è°ƒæ•´
            document.getElementById('adjustPointsBtn').addEventListener('click', showAdjustPointsModal);
            
            // æ¨¡æ€æ¡†æ§åˆ¶
            document.getElementById('cancelRedeem').addEventListener('click', function() {
                document.getElementById('redeemModal').classList.remove('active');
            });
            
            document.getElementById('confirmRedeem').addEventListener('click', function() {
                const modal = document.getElementById('redeemModal');
                const reward = JSON.parse(modal.dataset.selectedReward);
                
                if (useReward(reward)) {
                    modal.classList.remove('active');
                }
            });
            
            document.getElementById('cancelAdjustment').addEventListener('click', function() {
                document.getElementById('adjustPointsModal').classList.remove('active');
            });
            
            document.getElementById('confirmAdjustment').addEventListener('click', function() {
                const points = parseInt(document.getElementById('pointsAdjustment').value);
                const reason = document.getElementById('adjustmentReason').value.trim();
                
                if (isNaN(points)) {
                    showToast('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†å˜åŒ–');
                    return;
                }
                
                if (!reason) {
                    showToast('âš ï¸ è¯·è¾“å…¥è°ƒæ•´åŸå› ');
                    return;
                }
                
                if (adjustPoints(points, reason)) {
                    document.getElementById('adjustPointsModal').classList.remove('active');
                    showToast(`âœ… ç§¯åˆ†å·²è°ƒæ•´ ${points > 0 ? '+' : ''}${points}åˆ†\nåŸå› : ${reason}`);
                }
            });
            
            // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // 5. å®šæ—¶æ£€æŸ¥ï¼ˆæ¯30ç§’ï¼‰
            setInterval(() => {
                if (resetDailyTasks()) {
                    showToast('ğŸŒ™ æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼\nä»»åŠ¡å·²é‡ç½®ï¼Œè¯·å¼€å§‹ä»Šæ—¥æˆé•¿ã€‚');
                }
            }, 30000);
            
            console.log(`âœ… æˆé•¿æ‰“å¡ç³»ç»Ÿ v${SYSTEM_META.systemVersion} å·²åŠ è½½`);
            console.log('ğŸ’¡ æç¤º: ç‚¹å‡»æ—¥æœŸå¯æŸ¥çœ‹å†å²è®°å½•è¯¦æƒ…');
        });
    </script>
</body>
</html>
